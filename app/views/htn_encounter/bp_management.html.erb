<script language="javascript" type="text/javascript" src="/javascripts/jquery.js"></script>
<style>
  div.option {
      font-size: 1.9em;
      padding-left: 10px;
      padding-top: 5px;
  }
  th{
      background-color: silver;
      height: 20px;
      font-size: 1.1em;
      padding: 5px;
  }
  td {
      border-bottom:1pt solid black;
  }
  tr.highBP{
      background-color: #FFD000;
  }
  div.heading{
      background-color: lightgrey;
      font-size: 1.5em;
      padding: 10px;
      
  }
   #popup_box {
       display:none;
       z-index:1001;
       left:300px;
       top:100px;
       text-align:center;
       font-size:28;
       color: black;
       border: 2px solid #9999FF;
       border-radius: 15px 15px 15px 15px;
       border-style: outset;
       height: 160px;
       padding: 5px;
       position: absolute;
       top: 199px;
       width: 450px;
       -moz-user-select:none;
   }

  #popup_box span{
      font-size:35px;
  }

  #popup_box a{
      background-color: silver;
      border-bottom: 1px outset black;
      border-style: outset;
      padding: 10px 25px 10px 25px;
      border-radius:5px;
      font-size:29;
      cursor: pointer;

  }

  #cover{
      display: none;
      position: absolute;
      background-color: black;
      width: 100%;
      height: 102%;
      left: 0%;
      top: 0%;
      z-index: 1000;
      opacity: 0.5;
  }
  #risk_factor{
  	background: lightblue;
  	border-radius: 5px;
  	padding: 5px;  	 
  	color: black;
  	background-color: lightgray;
  	margin: 15px;
  	border: 3px outset gray;
  	-moz-user-select:none;  
  	text-align: center;
  }
</style>


<script type="text/javascript">
  <!--
    function selected(option)
    {
        options = document.getElementsByClassName("option")

        for(i = 0; i < options.length; i ++)
        {
           options[i].style.backgroundColor = "white";
           options[i].setAttribute("selected", false)
           options[i].children[0].firstChild.setAttribute("src", "/touchscreentoolkit/lib/images/unchecked.png")
        }

        var state = option.getAttribute('selected');
        option.setAttribute("selected",(state == "true" ? false : true));
        option.children[0].firstChild.setAttribute("src", (state == "true" ? "/touchscreentoolkit/lib/images/unchecked.png" : "/touchscreentoolkit/lib/images/checked.png"))
    }

    function nextPage()
    {
        options = document.getElementsByClassName("option")
        var checked = false;
        for(i = 0; i < options.length; i ++)
        {
            if (options[i].getAttribute("selected") == "true")

            {
                checked = true;
                switch (options[i].children[1].innerHTML){
                    case 'Start anti-hypertensives' :
                        path = "/htn_encounter/change_drugs?patient_id=<%= @patient.patient_id %>"
                        break;
                    case 'Review Drugs':
                        path = "/htn_encounter/bp_drug_management?patient_id=<%= @patient.patient_id %>&review=true"
                        break;
                    case 'Continue Drugs':
                        path = "/htn_encounter/bp_drug_management?patient_id=<%= @patient.patient_id %>"
                        break;
                    case 'Did not take prescribed BP drugs today':
                        path = "/htn_encounter/bp_drug_management?patient_id=<%= @patient.patient_id %>"
                        break;
                    default :
                        path = "<%= next_task(@patient)%>"
                        break;
                }

                return createEncounter(options[i].children[1].innerHTML, path, options[i].children[1].getAttribute("state"));

                break;
            }

        }
        if (checked == false)
            showMessage("Please select one action to proceed");
    }

    function createEncounter(chosenPlan, path, state)
    {

        if (state == "On Treatment")
        {
            state = null;
        }

        var dataHash = {"encounter": { "provider_id" : <%= User.current.user_id %>,
            "encounter_type_name" : "HYPERTENSION MANAGEMENT","patient_id" :<%= @patient.patient_id %> ,
            "encounter_datetime": '<%= session[:datetime].to_date rescue DateTime.now() %>'} ,
            "observations" : [{"patient_id":<%= @patient.patient_id %>, "concept_name":"PLAN", "value_text":chosenPlan,
            "obs_datetime":'<%= session[:datetime].to_date rescue DateTime.now() %>', "value_coded_or_text":""}],
            "return" : true, "state": state}
	
        jQuery.ajax({
            type: "POST",
            url: "/htn_encounter/create",
            dataType: 'json',
            contentType: 'application/json',
            data : JSON.stringify(dataHash),
            success: function(){
                    window.location =  path
            },
            error: function(){
                showMessage("Could not create record", "Unsuccessful")
            }

        });
    }

    function referPatient()
    {
        window.location = "/htn_encounter/refer_to_clinician?" +
                "patient_id=<%= @patient.patient_id %>&date='<%= session[:datetime].to_date rescue DateTime.now() %>'"
    }
  //-->
</script>

<div class="table" style="width: 100%;">
  <div class="row"  style="">
    <div class="cell">
      <div style="width: 96vw;margin-bottom: 5px; padding: 10px;font-size: 130%; font-weight: bold;">
        BP Management Screen (<%= session[:datetime].to_date.strftime('%d %B %Y') rescue DateTime.now().to_date.strftime('%d %B %Y') %>)
        <span style="float: right;">
        <span style="color: red;"> <%= (@note.blank? ? "" : " *" + @note)%></span>
         		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span onclick="window.location = '/htn_encounter/<%= @risks == 0 ? "medical_history" : "risk_factors_index"%>?patient_id=<%= @patient.id%>&reroute=true'" id="risk_factor" style="">
        		<%= @risks == 0 ? 'Add Risk Factors' : "View/Edit Risk Factors(<span style='color: red'>#{@risks}</span>)"%>        	
        </span>
        </span>
      </div>
      <div style="border:1px solid #000000; width: 96vw;margin-bottom: 5px;margin-top: 1px; margin-left: auto;margin-right: auto;padding: 10px;">
        <div><span style="font-weight: bold; font-size: 110%;">BP Trail</span></div>
        <div style="height: 45vh;overflow: auto;">
          <table style="width: 100%; margin-left: auto;margin-right: auto;">
            <thead>
            <tr>
              <th width="10%">Date</th>
              <th width="10%">Systolic</th>
              <th width="10%">Diastolic</th>
              <th>BP Drugs</th>
              <th width="20%">Action / Note</th>
            </tr>
            </thead>
            <tbody>
            <% (@bp_trail || []).each do  |record|  %>
                <tr class=<%= (record['systolic'].to_i > 140 || record['diastolic'].to_i > 90) ? 'highBP' : ''%> >
                  <td style="text-align: center"><%= record['date'] %></td>
                  <td style="text-align: center"><%= record['systolic'] %></td>
                  <td style="text-align: center"><%= record['diastolic'] %></td>
                  <td style="text-align: center"><%= @patient.current_bp_drugs(record['date'].to_date - 1.days).join(", ") %></td>
                  <td style="padding-left: 10px;"><%= record['plan'] %></td>
                </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <div class="row" >
    <div class="cell" >
      <div style="border:1px solid #000000; width: 97vw;margin-bottom: 5px;margin-top: 5px; margin-left: auto;margin-right: auto;height: 30vh;overflow:auto;">
        <div class="heading">
          Select Action
        </div>

          <div class="table" style="width: 100%;">
            <%
               session_date = session[:datetime].to_date rescue Date.today
               if !@patient.current_bp_drugs(session_date).blank? %>
                <div class="row">
                  <div class="cell"><div id = "1" class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle; "><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px; " state="On Treatment">Did not take prescribed BP drugs today</div>
                  </div>
                  </div>
                  <div class="cell"><div class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle;"><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px; " state="On Treatment">Continue Drugs</div>
                  </div>
                  </div>
                  <div class="cell"><div class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle;"><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px;" state="On Treatment">Review Drugs</div>
                  </div>
                  </div>
                </div>
            <% else %>
               <div class="row">
                  <div class="cell"><div id = "1" class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle; "><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px; " state="Lifestyle changes only">Lifestyle Advice given</div>
                  </div>
                  </div>
                  <div class="cell"><div class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle;"><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px; " state="Symptomatic but NOT in treatment">Not yet stable on ART</div>
                  </div>
                  </div>
                  <div class="cell"><div class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle;"><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px;" state="Symptomatic but NOT in treatment">Patient Declining BP drugs</div>
                  </div>
                  </div>
                </div>
                <div class="row">
                  <div class="cell"><div class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle; "><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px;" state="Alive">Return to annual screening</div>
                  </div>
                    </div>
                  <div class="cell"><div class="option" selected=false onclick="selected(this)">
                    <div style="display: table-cell; vertical-align: middle; "><img src="/touchscreentoolkit/lib/images/unchecked.png"></div>
                    <div style="display: table-cell; vertical-align: middle;padding-left: 5px;" state="On Treatment">Start anti-hypertensives</div>
                  </div>
                </div>
               </div>
            <% end %>
          </div>
      </div>
     </div>
  </div>

</div>
<div id="buttons" class="buttonsDiv">
  <button id="nextButton" class="button green navButton" onmousedown="nextPage()"><span>Finish</span></button>
  <% roles = current_user_roles.join(',') rescue '' %>
  <% if !(roles.match(/Clinician/i) or roles.match(/Doctor/i)) %>
      <button id="referButton" class="button red navButton" style="float: left"
              onmousedown="referPatient()"><span>Refer to Clinician</span></button>
  <% end %>
</div>
